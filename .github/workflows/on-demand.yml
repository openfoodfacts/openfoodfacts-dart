# This file contains actions that can be performed on PRs by issuing a comment
name: ðŸ•¹ï¸ On demand PR action

on:
  issue_comment:
    types: [created, edited]

jobs:
  # Action to update test results by issuing /lint
  run_lint:
    name: "On demand linting"
    permissions:
      contents: write
    if: |
      github.event.issue.pull_request &&
      (github.event.comment.body == '/lint') &&
      contains(fromJSON('["COLLABORATOR", "CONTRIBUTOR", "MEMBER", "OWNER"]'), github.event.comment.author_association)
    runs-on: ubuntu-latest
    steps:
    - name: Get branch name and commit SHA
      # see https://github.com/actions/checkout/issues/331
      id: get-branch
      run: |
        echo "branch=$(gh pr view $PR_NO --repo $REPO --json headRefName --jq '.headRefName')" >> $GITHUB_OUTPUT
        echo "sha=$(gh pr view $PR_NO --repo $REPO --json headRefOid --jq '.headRefOid')" >> $GITHUB_OUTPUT
      env:
        REPO: ${{ github.repository }}
        PR_NO: ${{ github.event.issue.number }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        # grab the PR commit SHA (immutable reference)
        ref: ${{ steps.get-branch.outputs.sha }}
        # We can't use GITHUB_TOKEN here because, github actions can't trigger actions
        # see: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#using-the-github_token-in-a-workflow
        # So this is a personal access token
        token: ${{ secrets.GITHUB_TOKEN }}
    # we need origin/main to have comparison linting work !
    - name: Fetch origin/develop
      run: |
        git remote set-branches --add origin main
        git fetch origin
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        #channel: stable
        cache: true
        flutter-version: ${{ steps.flutter-version.outputs.FLUTTER_VERSION }}
        cache-key: flutter-${{ hashFiles('flutter-version.txt')}}-${{ hashFiles('packages/smooth_app/pubspec.lock')}}
      # Check for formatting issues and fix them
    - name: Check for formatting issues (run "dart format . ")
      run: dart format .
    - name: Verify branch head matches checked out SHA
      run: |
        set -e
        BRANCH="${{ steps.get-branch.outputs.branch }}"
        SHA="${{ steps.get-branch.outputs.sha }}"
        REMOTE_SHA=$(git ls-remote origin "refs/heads/$BRANCH" | awk '{print $1}')
        if [ "$REMOTE_SHA" != "$SHA" ]; then
          echo "Branch $BRANCH has changed since initial checkout (was $SHA, now $REMOTE_SHA). Aborting push."
          exit 1
        fi
    - name: Push changes if needed
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "chore: Linting changes"
        branch: ${{ steps.get-branch.outputs.branch }}
        commit_user_name: Open Food Facts Bot
        commit_user_email: contact@openfoodfacts.org
        commit_author: Open Food Facts Bot <contact@openfoodfacts.org>
        push_options: ""
        status_options: '--untracked-files=no'
        skip_dirty_check: false
        create_branch: no
